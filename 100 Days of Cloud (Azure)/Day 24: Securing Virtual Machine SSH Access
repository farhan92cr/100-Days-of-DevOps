Day 24: Securing Virtual Machine SSH Access:

Day 24: Securing Virtual Machine SSH Access:
~ ✖ RG=$(az group list --query "[0].name" -o tsv) && echo "Resource Group: $RG"
Resource Group: kml_rg_main-42b0b219e6c34f89
The Nautilus DevOps team needs to set up a new Virtual Machine (VM) on the Azure cloud that can be accessed securely from their landing host (azure-client). Follow the steps below to complete this task:

Create an SSH Key: On the azure-client host, check if an SSH key already exists. If it doesn’t exist, create a new SSH key on the azure-client host that will be used for password-less SSH access.

Create a Virtual Machine: Use the Azure Portal or Azure CLI to create a new Virtual Machine named devops-vm in the westus region. Set the VM size to Standard_B1s and configure the VM with SSH access for the azureuser account using the newly created SSH key.

Configure SSH Access: Ensure that the SSH key from the azure-client host is added to the azureuser account on devops-vm, enabling secure, password-less SSH access from the azure-client host.

Verify Connectivity: Test the connection from azure-client to devops-vm using SSH to confirm that password-less access has been set up correctly.

Complete these tasks entirely within the Azure Portal or Azure CLI.


Use the below given Azure Credentials: (You can run the showcreds command on azure-client host to retrieve these credentials)

Portal URL	https://portal.azure.com
Username	kk_lab_user_main-42b0b219e6c34f89@azurefreekmlprod.onmicrosoft.com
Password	m4QMPHjs
Start Time	Tue Dec 30 05:13:28 UTC 2025
End Time	Tue Dec 30 06:13:28 UTC 2025
Notes:

Create the resources only in westus region.

To display or hide the terminal of the Azure client machine, you can use the expand toggle button as shown below:



SOlution:
Here are the exact one-line commands to complete Day 24's task, using the resource group you identified (kml_rg_main-42b0b219e6c34f89). This lab focuses on manually creating and managing SSH keys for secure access.

Step-by-Step Commands
Login to Azure with the new credentials.

bash
az login -u kk_lab_user_main-42b0b219e6c34f89@azurefreekmlprod.onmicrosoft.com -p m4QMPHjs
Check for existing SSH keys and generate a new one if needed. This command creates a key named devops_vm_key in the ~/.ssh directory.

bash
[ ! -f ~/.ssh/devops_vm_key.pub ] && ssh-keygen -m PEM -t rsa -b 4096 -f ~/.ssh/devops_vm_key -N "" && echo "New key created: devops_vm_key" || echo "Key ~/.ssh/devops_vm_key.pub already exists."
Create the VM in the westus region. The key difference from previous labs is using the --ssh-key-values parameter to explicitly attach your existing public key.

bash
az vm create --resource-group kml_rg_main-42b0b219e6c34f89 --name devops-vm --image Ubuntu2204 --size Standard_B1s --admin-username azureuser --ssh-key-values ~/.ssh/devops_vm_key.pub --public-ip-sku Standard --location "westus" --nsg-rule SSH --os-disk-size-gb 128 --storage-sku StandardSSD_LRS
Get the public IP to test the connection.

bash
IP=$(az vm show --resource-group kml_rg_main-42b0b219e6c34f89 --name devops-vm --show-details --query "publicIps" -o tsv) && echo "VM IP: $IP"
Test SSH connectivity using your private key. This verifies password-less access was configured.

bash
ssh -i ~/.ssh/devops_vm_key -o ConnectTimeout=20 -o StrictHostKeyChecking=no azureuser@$IP "echo 'SSH key access confirmed for user: $(whoami)'"
Key Differences from Day 22/23
Task	Day 22/23	Day 24 (Today)
Region	East US	West US
SSH Key	Used --generate-ssh-keys (Azure creates it)	You must create the key yourself and use --ssh-key-values
Goal	Automate Nginx setup via script	Manually set up and verify SSH key-based authentication
Troubleshooting
"Permission denied (publickey)" error: This means the wrong key is being used. Double-check you are connecting with the correct private key (-i ~/.ssh/devops_vm_key).

VM fails to create with policy error: The command already includes the required disk parameters. If it still fails, check the exact error message.

SSH key not found: If Step 2 indicated the key didn't exist but creation failed, run the key generation command directly:

bash
ssh-keygen -m PEM -t rsa -b 4096 -f ~/.ssh/devops_vm_key -N ""
How to Verify the Setup Manually
To absolutely confirm that Azure added your public key to the VM, you can log in and check the authorized_keys file:

bash
ssh -i ~/.ssh/devops_vm_key azureuser@$IP "cat ~/.ssh/authorized_keys"
You should see the public key from ~/.ssh/devops_vm_key.pub in the output.



.....


