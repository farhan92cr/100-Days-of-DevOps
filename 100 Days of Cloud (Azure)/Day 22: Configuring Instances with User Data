Day 22: Configuring Instances with User Data:
The Nautilus DevOps Team is working on setting up a new virtual machine (VM) to host a web server for a critical application. The team lead has requested you to create an Azure VM that will serve as a web server using Nginx. This VM will be part of the initial infrastructure setup for the Nautilus project. Ensuring that the server is correctly configured and accessible from the internet is crucial for the upcoming deployment phase.

As a member of the Nautilus DevOps Team, your task is to create a VM with the following specifications:

Instance Name: The VM must be named nautilus-vm.

Image: Use any available Ubuntu image to create this VM.

Custom Script Extension/User Data: Configure the VM to run a custom script during its launch. This script should:

Install the Nginx package.
Start the Nginx service.
Network Security Group (NSG): Ensure that the VM allows HTTP traffic on port 80 from the internet.



Use below given Azure Credentials: (You can run the showcreds command on azure-client host to retrieve these credentials)

Portal URL	https://portal.azure.com
Username	kk_lab_user_main-25d7d6681af443d1@azurefreekmlprod.onmicrosoft.com
Password	z8RY2gxN
Start Time	Tue Dec 23 06:26:29 UTC 2025
End Time	Tue Dec 23 07:26:29 UTC 2025

Notes:

Create the resources only in the East US region.
You may use the default resource group or create a new one if needed.

SOLUTION:

Here are the exact CLI commands to create the VM with Nginx pre-installed for Day 22. The key step is using the Custom Script Extension to run an installation script automatically after the VM is created 



SOLUTION:

1. First, create the VM with an SSH rule only.

bash
az vm create --resource-group kml_rg_main-25d7d6681af443d1 --name nautilus-vm --image Ubuntu2204 --size Standard_B1s --admin-username azureuser --generate-ssh-keys --public-ip-sku Standard --location "East US" --nsg-rule SSH --os-disk-size-gb 128 --storage-sku StandardSSD_LRS
2. Add a rule to allow HTTP (port 80) traffic.
The VM creation command will automatically generate a Network Security Group (NSG) named nautilus-vmNSG. This command adds a rule to it.

bash
az network nsg rule create --resource-group kml_rg_main-25d7d6681af443d1 --nsg-name nautilus-vmNSG --name AllowHTTP --priority 1010 --direction Inbound --access Allow --protocol Tcp --source-address-prefixes '*' --source-port-ranges '*' --destination-address-prefixes '*' --destination-port-ranges 80
The --priority 1010 ensures this rule runs after the default SSH rule (priority 1000) but before the default "DenyAllInbound" rule (priority 65500).

3. Add the Custom Script Extension to install Nginx.

bash
az vm extension set --resource-group kml_rg_main-25d7d6681af443d1 --vm-name nautilus-vm --name customScript --publisher Microsoft.Azure.Extensions --version 2.1 --protected-settings '{"commandToExecute": "sudo apt-get update && sudo apt-get install -y nginx && sudo systemctl start nginx"}'


--


What's Happening and Why It Works
The table below explains the key concepts behind the commands you ran:

Component	What It Does	Why It's Required
--nsg-rule "HTTP"	Creates a firewall rule in the Network Security Group (NSG) to allow inbound traffic on port 80 from the internet .	Makes the Nginx web server accessible from the internet.
Custom Script Extension	Downloads and executes a script inside the VM after it boots .	Automates the configuration (installs and starts Nginx) without manual SSH login.
--generate-ssh-keys	Automatically creates an SSH key pair for secure access to the VM .	Satisfies the lab requirement for SSH key access.
Note: If you get a "Resource 'nautilus-vm' was disallowed by policy" error (like in previous labs), you may need to add disk size and type parameters (e.g., --os-disk-size-gb 128 --storage-sku StandardSSD_LRS) to the first az vm create command.

..

,,


