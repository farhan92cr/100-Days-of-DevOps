Day 21: Assigning Public IP to Virtual Machines:

The Nautilus DevOps Team has received a new request from the Development Team to set up a new Azure Virtual Machine (VM). This VM will be used to host a new application that requires a stable public IP address. To ensure that the VM has a consistent public IP, a Static Public IP address needs to be associated with it. The VM will be named xfusion-vm, and the Static Public IP will be named xfusion-pip. This setup will help the Development Team to have a reliable and consistent access point for their application.

Create an Azure VM named xfusion-vm using any available Ubuntu image, with the VM size Standard_B1s.
Generate an SSH public key on the azure-client host and associate it with the VM for SSH access.
Associate a Static Public IP address named xfusion-pip with this VM.
Ensure the VM is accessible via SSH using the generated public key.

Use below given Azure Credentials: (You can run the showcreds command on the azure-client host to retrieve these credentials)

Portal URL	https://portal.azure.com
Username	kk_lab_user_main-d039ffd6902447ec@azurefreekmlprod.onmicrosoft.com
Password	A4E45hJ@
Start Time	Tue Dec 23 05:07:28 UTC 2025
End Time	Tue Dec 23 06:07:28 UTC 2025

Notes:

Perform all operations in the East US region.

SOLUTION:


Step 1: Set Resource Group (skip login)

bash
RG=kml_rg_main-47e32ae6362c4b8b
Step 2: Generate SSH Key

bash
ssh-keygen -m PEM -t rsa -b 4096 -f ~/.ssh/nautilus_vm_key -N ""
Step 3: Create VM (Most Reliable Version)

bash
az vm create --resource-group $RG --name nautilus-vm --image Ubuntu2204 --size Standard_B1s --admin-username azureuser --generate-ssh-keys --public-ip-address nautilus-pip --public-ip-sku Standard --location "East US" --nsg-rule SSH --os-disk-size-gb 128 --storage-sku StandardSSD_LRS
Step 4: Get IP and Test SSH

bash
IP=$(az vm show --resource-group $RG --name nautilus-vm --show-details --query "publicIps" -o tsv) && echo "VM IP: $IP" && ssh -i ~/.ssh/id_rsa -o ConnectTimeout=30 -o StrictHostKeyChecking=no azureuser@$IP "echo 'SSH success'"
Key Points:
Skip az login - Cloud Shell is already authenticated

Use --generate-ssh-keys - Let Azure create the SSH keys (avoids key path issues)

Connect with ~/.ssh/id_rsa - This is the default key Azure generates

The RG variable ensures you use the correct resource group

If VM Creation Fails with Policy Error:
Try checking what resource group exists:

bash
az group list --query "[].name" -o table
Then use the correct RG name in the command.

Alternative if Azure-generated key fails:
Use your manually generated key instead:

bash
az vm create --resource-group $RG --name nautilus-vm --image Ubuntu2204 --size Standard_B1s --admin-username azureuser --ssh-key-values ~/.ssh/nautilus_vm_key.pub --public-ip-address nautilus-pip --public-ip-sku Standard --location "East US" --nsg-rule SSH --os-disk-size-gb 128 --storage-sku StandardSSD_LRS
Run Step 1, then Step 2, then Step 3. The --generate-ssh-keys option is the most reliable for Cloud Shell.

